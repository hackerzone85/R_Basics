```{r prologue, results='hide', echo=FALSE}
knitr::opts_chunk$set(warning = FALSE
                      , message = FALSE
                      , echo = FALSE
                      )
```

```{r setup}
require(vcd)
require(lattice)
require(directlabels)
require(gridExtra)
```

# Visualising Categorical Data

#### Exercise 3.1 The Arbuthnot data in HistData (Example 3.1) also contains the variable Ratio, giving the ratio of male to female births.

(a)	Make a plot of Ratio over Year, similar to Figure 3.1. What features stand out? Which plot do you prefer to display the tendency for more male births?

*Here is the original plot referred to in the question:*

```{r}
# op <- par(mar = c(4,4,1,1) + .1, cex.lab = 1.25)

data("Arbuthnot", package = "HistData")

with(Arbuthnot, {
  prob = Males / (Males + Females)
  plot(x = Year, y = prob, type = "b",
       ylim = c(0.5, 0.54)
       , ylab = "Pr (Male)"
       , main = "Arbuthnot's data on male/female sex ratios in London, 1629-1710")
  abline(h = 0.5, col = "red", lwd = 2)
  abline(h = mean(prob), col = "blue")
  lines(loess.smooth(Year, prob), col = "blue", lwd = 2)
  text(x = 1640, y = 0.5, expression(H[0]: "Pr(Male)=0.5"),
       pos = 3, col = "red")
  })
```

```{r}
with(Arbuthnot, {
  plot(x = Year, y = Ratio, type = "b"
       , ylim = c(1, max(Ratio) + 0.01)
       , ylab = "Pr (Male)"
       , main = "Same plot, this time against ratio")
  abline(h = 1, col = "red", lwd = 2)
  abline(h = mean(Ratio), col = "blue") 
  lines(loess.smooth(Year, Ratio), col = "blue", lwd = 2)
  text(x = 1640, y = 1, expression(H[0]: "Ratio Male:Female = 1"),
       pos = 3, col = "red")
  })
```

*The plots are essentially identical. The choice to use either would depend on context and audience.*

(b)	Plot the total number of christenings, Males + Females or Total (in 000s) over time. What unusual features do you see?

```{r}
with(Arbuthnot, {
  TotC <- (Males + Females)/1000
  plot(x = Year, y = TotC, type = "b"
       , ylab = "Christenings (thousands)"
       , main = "Total number of Christenings (Arbuthnot's data)"
       )
  lines(loess.smooth(Year, TotC, degree = 1), col = "blue", lwd = 2)
  })
```

*There is a linear increasing trend which is interrupted for almost two decades, presumably by plague. There is a second unexpected dip at around 1705.*

#### Exercise 3.2 Use the graphical methods illustrated in Section 3.2 to plot a collection of geometric distributions for p = 0.2, 0.4, 0.6, 0.8, over a range of values of k = 0, 1, ..., 10.

(a)	With xyplot(), try the different plot formats using points connected with lines, as in Figure 3.9, or using points and lines down to the origin, as in the panels of Figure 3.10.

```{r}
PL <- expand.grid(k = 0 : 10
                  , probs = c(0.2, 0.4, 0.6, 0.8))
geom_df <- data.frame(PL, prob = dgeom(PL$k, PL$probs))
geom_df$probs = factor(geom_df$probs)
str(geom_df)

xyplot(prob ~ k | probs, data = geom_df,
       type = c("h", "p"), pch = 16, lwd = 2, cex = 1.25, layout = c(2, 2),
       xlab = list("Number of events (k)", cex = 1.25),
       ylab = list("Probability", cex = 1.25))
```

(b)	Also with xyplot (), produce one version of a multi-line plot in a single panel that you think shows well how these distributions change with the probability p of success.

```{r}
# use direct labels as an alternative way to legend a plot (lattice)
mycol <- palette()[2:5]
plt <- xyplot(prob ~ k, data = geom_df, groups = probs,
              type = "b", pch = 15 : 18, lwd = 2, cex = 1.25, col = mycol,
              xlab = list("Number of events (k)", cex = 1.25),
              ylab = list("Probability",  cex = 1.25),
              ylim = c(0, 1)
              )

library(directlabels)
direct.label(plt, list("top.points", cex = 1.5, dl.trans(y = y + 0.1)))
```

(c)	Do the same in a multi-panel version, conditional on p.

```{r}
# use direct labels as an alternative way to legend a plot (lattice)
mycol <- palette()[2:5]
plt <- xyplot(prob ~ k | probs, data = geom_df, groups = probs,
              layout = c(2,2),
              type = "b", pch = 15 : 18, lwd = 2, cex = 1.25, col = mycol,
              xlab = list("Number of events (k)", cex = 1.25),
              ylab = list("Probability",  cex = 1.25),
              ylim = c(0, 1)
              )

library(directlabels)
direct.label(plt, list("top.points", cex = 1.5, dl.trans(y = y + 0.1)))
```

#### Exercise 3.3 Use the data set WomenQueue to:

(a)	Produce plots analogous to those shown in Section 3.1 (some sort of bar graph of frequencies).

*First a basic bar plot of the observed frequencies*

```{r}
data("WomenQueue", package = "vcd")
barplot(WomenQueue, col = "lightblue", cex.lab = 1.5
        , xlab = "Number of women"
        , ylab = "Number of queues"
        , main = "Basic plot of Frequency Distribution")
```

(b)	Check for goodness-of-fit to the binomial distribution using the goodfit () methods described in Section 3.3.2.

```{r}
WQ <- goodfit(WomenQueue, type = "binomial")
unlist(WQ$par)
WQ
summary(WQ)
```

(c)	Make a reasonable plot showing departure from the binomial distribution.

```{r}
plot(WQ, type = "hanging", shade = TRUE)
```

(d)	Suggest some reasons why the number of women in queues of length 10 might depart from a binomial distribution, Bin(n = 10, p = 1/2).

*The estimated p = unlist(WQ$par)[1] They may have chivalrous boyfriends who offer to queue for them, or they may have a lower tolerance for queueing (i.e. they see a queue and turn away)*

#### Exercise 3.4 Continue Example 3.13 on the distribution of male children in families in Saxony by fitting a binomial distribution, Bin(n = 12, p = 1/2) specifying equal probability for boys and girls. [Hint: you need to specify both size and prob values for goodfit().]

(a)	Carry out the GOF test for this fixed binomial distribution. What is the ratio of $\frac{\chi^2}{df}$? What do you conclude?

```{r}
data("Saxony", package = "vcd")
SX <- goodfit(Saxony, type = "binomial", par = list(prob = 0.5, size = 12))
sumSX <- summary(SX)
```

*The ratio of $\frac{\chi^2}{df}$ is $\frac{ `r round(sumSX[1,1],4)` }{ `r sumSX[1,2]` } = `r round(sumSX[1,1]/sumSX[1,2],4) `$*

*This is well above the rule of thumb 2.5 indicating a very poor fit to the binomial distribution, Bin(n = 12, p = 1/2). The p values is also approximately zero.*

(b)	Test the additional lack of fit for the model Bin(n = 12, p = $\hat{p}$)  compared to the model Bin(n = 12, p = $\hat{p}$) where $\hat{p}$ is estimated from the data.

*The model fit and estimated from the data is:*

```{r}
Sax_fit <- goodfit(Saxony, type = "binomial")
unlist(Sax_fit$par) # estimated parameters
```

(c)	Use the plot.gootfit () method to visualize these two models.

```{r}
plot(SX, shade = TRUE, main = "p = 0.5")
plot(Sax_fit, shade = TRUE, main = expression(paste("p = ", hat(p))))
```

#### Exercise 3.5 For the Federalist data, the examples in Section 3.3.1 and Section 3.3.2 showed the negative binomial to provide an acceptable fit. Compare this with the simpler special case of geometric distribution, corresponding to n = 1.

(a)	Use goodfit() to fit the geometric distribution. [Hint: use type="nbinomial", but specify size=1 as a parameter.]

```{r}
Fed_fitg <- goodfit(Federalist, type = "nbinomial", par = list(size = 1))
unlist(Fed_fitg$par)
sumFg <- summary(Fed_fitg)
```

(b)	Compare the negative binomial and the geometric models statistically, by a likelihood-ratio test of the difference between these two models.

```{r}
Fed_fitn <- goodfit(Federalist, type = "nbinomial")
unlist(Fed_fitn$par)
sumFn <- summary(Fed_fitn)

pchisq(sumFg[1]-sumFn[1], df = sumFg[2]-sumFn[2], lower.tail = FALSE)
```

(c)	Compare the negative binomial and the geometric models visually by hanging rootograms or other methods.

```{r}
plot(Fed_fitg, shade = TRUE, main = "geometric model")
plot(Fed_fitn, shade = TRUE, main = "negative binomial model")

distplot(Federalist, type = "nbinomial", size = 1
         , main = "geometricness plot")
distplot(Federalist, type = "nbinomial", main = "negative binomialness plot")
```

