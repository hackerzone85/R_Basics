```{r prologue, results='hide', echo=FALSE}
knitr::opts_chunk$set(warning = FALSE
                      , message = FALSE
                      , echo = FALSE
                      )
```

```{r setup}
require(vcd)
require(vcdExtra)
require(MASS)
require(lmtest)
require(effects)
require(lattice)
require(splines)
require(gpairs)
```

---
title: "VCD Exercise 7"
author: "Julian Hatwell"
date: "27 March 2016"
output: html_document
---

## 7.1 
Arbuthnot's data on the sex ratio of births in London was examined in Example 3.1. Use a binomial logistic regression model to assess whether the proportion of male births varied with the variables Year, Plague, and Mortality in the Arbuthnot data set. Produce effect plots for the terms in this model. What do you conclude?

```{r}
data("Arbuthnot", package = "HistData")
```


*First, exploring the data.*

*It is obvious that Year is a continuous time series. Looking to see how the other variables are distributed:*

```{r}
histblue <- function(x, nm) {
  hist(x, col = "lightblue"
       , border = "darkblue"
       , col.axis = "darkblue"
       , col.lab = "darkblue"
       , col.main = "darkblue"
       , xlab = nm
       , main = paste("Histogram of", nm))
  }
oldpar <- par()
par(mfrow = c(2,2))
histblue(Arbuthnot$Mortality, "Mortality")
histblue(Arbuthnot$Plague, "Plague")
histblue(log(Arbuthnot$Mortality), "log(Mortality)")
histblue(log(Arbuthnot$Plague), "log(Plague)")

par(oldpar)   
```

*Both variables show an extreme skew and a single extreme reading, which may warrant further attention.*

*Now to fitting only one variable at a time.*

```{r}
arb.glm1y <- glm(cbind(Males, Females) ~ Year
    , data = Arbuthnot, family = binomial)
coeftest(arb.glm1y)
anova(arb.glm1y, test = "Chisq")
```

*This coef appears to be significant but is not terribly informative. However, it is known that the data is collected over 81 year's, so it's possible to calculate what effect this would have from the start to the end of the period.*

```{r, echo=TRUE}
cat("odds ratio for Year", exp(coef(arb.glm1y)["Year"]))
cat("odds ratio for Year, after 81 years",exp(coef(arb.glm1y)["Year"]*81))
```

*From this result, it appears that P(Male) decreases by 2% (i.e. multiplied by 0.98) over the period 1629-1710. The $\chi^2$ result is significant, so despite the very small effect, there is > 99% confidence that this is not a chance reading.*

```{r}
arb.glm1p <- glm(cbind(Males, Females) ~ Plague
    , data = Arbuthnot, family = binomial)
coeftest(arb.glm1p)
cat("odds ratio for Plague", exp(coef(arb.glm1p)["Plague"]))
anova(arb.glm1p, test = "Chisq")
```

*The plague variable does not appear to be significant, at least as a sole predictor.*

```{r}
arb.glm1m <- glm(cbind(Males, Females) ~ Mortality
    , data = Arbuthnot, family = binomial)
coeftest(arb.glm1m)
cat("odds ratio for Mortality", exp(coef(arb.glm1m)["Mortality"]))
anova(arb.glm1m, test = "Chisq")
```

*The various tests show significance for this variable, though again the effects are tiny.*

*Now a model with all three, as per the question, although now there is the assumption that Plague is not a useful predictor.*

```{r}
arb.glm3a <- glm(cbind(Males, Females) ~ Year+Plague+Mortality
    , data = Arbuthnot, family = binomial)
coeftest(arb.glm3a)
anova(arb.glm3a, test = "Chisq")
```

*There is quite an unexpected result here in the coefs. Year, not significant while plague moderately signif. Mortality as expected.*

*The ANOVA test is closer to expectations, though order matters here.*

*Refitting in a different order:*

```{r}
arb.glm3b <- glm(cbind(Males, Females) ~ Plague+Mortality+Year
    , data = Arbuthnot, family = binomial)
coeftest(arb.glm3b)
anova(arb.glm3b, test = "Chisq")
```

*Mortality the only imporant var this time. This is all very inconsistent.*

*Taking a look at the effect plots (for the first model Year+Plague+Mortality):*

```{r}
arb.eff <- allEffects(arb.glm3a, partial.residuals = TRUE)
plot(arb.eff, ylab = "P(Male)")
```

*In the Year effect plot there is a reflection of the nonlinear trend seen in the early chapters. The two other plots are impossible to diagnose because of the high skew and the presence of one outlier point, as was discovered by exploration.*

*It will be necessary to use transformed versions of these vars, possibly ommitting the outlier, which is completely outside the normal range.*

```{r}
head(Arbuthnot[order(Arbuthnot$Mortality, decreasing = TRUE),])
head(Arbuthnot[order(Arbuthnot$Plague, decreasing = TRUE),])
```

*It appears that point 37 has extreme values for both Plague and Mortality.*

```{r, echo=TRUE}
Arb <- Arbuthnot[-37,]
Arb$logPlague <- log(Arb$Plague + 1) # correct for zeros
Arb$logMortality <- log(Arb$Mortality + 1) # correct for zeros
```

*Time to have another look at how the data are distributed*

```{r}
gpairs(Arb[,c(1,6,8,9)])
cor(Arb[,c(1,6,8,9)])
```

*The high correlation between the vars of interest is a cause for attention. This may be a cause to remove one or two of them or to look for interaction terms.*

*First, fitting with the log transformed variables:*

```{r}
arb.glm3lg <- glm(cbind(Males, Females) ~ Year+logPlague+logMortality
    , data = Arb, family = binomial)
coeftest(arb.glm3lg)
exp(coef(arb.glm3lg))
anova(arb.glm3lg, test = "Chisq")
```

*These results again are a little inconsistent but comes out on the side of Year and logMortality being important. It looks like log(Plague) can certainly be ignored.*

```{r}
arb.eff <- allEffects(arb.glm3lg, partial.residuals = TRUE)
plot(arb.eff, ylab = "P(Male)")
```

*Looking at the effect plot, there may be a quadratic relationship with log(Plague), and perhaps a cubic/natural spline term for Year to correct for the observed nonlinearity there.*

```{r}
arb.glm3nl <- glm(cbind(Males, Females) ~ ns(Year, 3)+poly(logPlague,2)+logMortality
    , data = Arb, family = binomial)
coeftest(arb.glm3nl)
anova(arb.glm3nl, test = "Chisq")

arb.eff <- allEffects(arb.glm3nl, partial.residuals = TRUE)
plot(arb.eff, ylab = "P(Male)")
```

*Adding in a basis function to try to capture the hockey stick in the loess on residuals of logMortality effect plot.*

```{r, echo=TRUE}
# basis function for the hockey stick line in the effect plot
basis1 <- function(X) {
  x <- if (X >=9.7) { (X-9)^2 } else { 0 }
  X - x
}
```

```{r}
Arb$basisMortality <- sapply(Arb$logMortality, basis1)

arb.glm3nl2 <- glm(cbind(Males, Females) ~ ns(Year, 3)+poly(logPlague,2)+poly(basisMortality,2)
    , data = Arb, family = binomial)
anova(arb.glm3nl2, test = "Chisq")

arb.eff <- allEffects(arb.glm3nl2, partial.residuals = TRUE)
plot(arb.eff, ylab = "P(Male)")
```

*logPlague still looks like it's significant while basis(logMortality) in not at all. However, it's really the spline on Year that is the model of interest here.*

*Now looking at simple interactions between the terms:*

```{r}
arb.glm3in <- glm(cbind(Males, Females) ~ Year*logMortality*logPlague
    , data = Arb, family = binomial)
anova(arb.glm3in, test = "Chisq")

arb.eff <- allEffects(arb.glm3in, partial.residuals = TRUE)
plot(arb.eff, ylab = "P(Male)")
```

*From all this exploration it seems reasonable to exclude plague and look at interactions between ns(Year,3) and poly(log(Mortality),2)*

```{r}
arb.glm2in <- glm(cbind(Males, Females) ~ ns(Year,3)*poly(logMortality,2)
    , data = Arb, family = binomial)
anova(arb.glm2in, test = "Chisq")

arb.eff <- allEffects(arb.glm2in, partial.residuals = TRUE)
plot(arb.eff, ylab = "P(Male)", main = "")
plot(arb.eff, ylab = "P(Male)", main = ""
     , multiline = TRUE
     , ci.style = "bands"
     , key.args = list(columns = 2))

LRstats(arb.glm1y, arb.glm3a)
LRstats(arb.glm3nl, arb.glm2in)
```

*This model appears to fit the data very well, although this is not reflected in the likelihood ratio test against the saturated model. Nevertheless it does better than all the others (a selection are shown).*

*This investigation has shown the complexity of working with highly correlated variables. To conclude, the findings are that there is a non-linear relationship with an interaction between a spline function of Year and quadratic in the log transformed Mortality rate. This is quite difficult to interpret.*

*The spline term on Year is probably the best representation of some trend over time. The interaction effect of mortality may possibly be explained as some kind of reaction to mortality/survival of children already born inlfuencing birth rates, which could cause systemic, time delayed fluctuations. How this would translate into changes in the ratio of males to females is anybody's guess.*
